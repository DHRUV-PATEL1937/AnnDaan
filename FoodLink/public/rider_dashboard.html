<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FoodLink Rider Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <link rel="stylesheet"
            href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script src="https://unpkg.com/lucide@latest"></script>

        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

        <style>
            body {
                font-family: 'Inter', sans-serif;
            }

            .sidebar-icon {
                width: 24px;
                height: 24px;
            }

            ::-webkit-scrollbar {
                width: 6px;
            }

            ::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            ::-webkit-scrollbar-thumb {
                background: #888;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            #map {
                height: 100%;
                width: 100%;
            }

            .leaflet-routing-container {
                display: none !important;
            }

            .leaflet-popup-content-wrapper,
            .leaflet-popup-tip {
                border-radius: 8px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .toggle-checkbox:checked {
                transform: translateX(100%);
                border-color: #2563eb;
            }

            .toggle-checkbox:checked+.toggle-label {
                background-color: #2563eb;
            }

            .new-donation-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10B981, #059669);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                transform: translateX(400px);
                transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
                z-index: 1000;
                max-width: 300px;
            }

            .new-donation-notification.show {
                transform: translateX(0);
            }

            .notification-pulse {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {

                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.05);
                }
            }
        </style>
    </head>

    <body class="bg-gray-50 text-gray-800">

        <div id="donation-notification" class="new-donation-notification">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i data-lucide="utensils" class="w-4 h-4"></i>
                </div>
                <div>
                    <h4 class="font-semibold text-sm">New Pickup Available!</h4>
                    <p id="notification-text" class="text-xs opacity-90"></p>
                </div>
            </div>
        </div>

        <div class="flex h-screen">
            <aside class="w-20 bg-white border-r flex flex-col items-center py-4 space-y-6">
                <div class="flex items-center justify-center flex-col">
                    <div class="text-blue-600 font-bold text-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-box">
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                            <line x1="12" y1="22.08" x2="12" y2="12" />
                        </svg>
                    </div>
                    <span class="font-bold text-sm mt-1 text-gray-700">FoodLink</span>
                </div>

                <nav class="flex flex-col items-center space-y-4 flex-grow">
                    <a href="#" id="dashboard-link" class="p-3 bg-blue-100 text-blue-600 rounded-lg"
                        title="Dashboard"><i data-lucide="layout-dashboard" class="sidebar-icon"></i></a>
                    <a href="#" id="profile-link" class="p-3 text-gray-500 hover:bg-gray-100 rounded-lg"
                        title="Profile"><i data-lucide="user" class="sidebar-icon"></i></a>
                    <a href="#" id="support-link" class="p-3 text-gray-500 hover:bg-gray-100 rounded-lg"
                        title="Support"><i data-lucide="life-buoy" class="sidebar-icon"></i></a>
                </nav>
                <div class="p-3 text-gray-500 hover:bg-gray-100 rounded-lg cursor-pointer" title="Logout"><i
                        data-lucide="log-out" class="sidebar-icon"></i></div>
            </aside>

            <main class="flex-1 flex flex-col">
                <header class="bg-white border-b px-6 py-3 flex justify-between items-center">
                    <div>
                        <span id="welcome-message" class="font-semibold text-gray-800">Welcome, Rider!</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="status-container" class="flex items-center gap-4">
                            <div id="status-indicator" class="flex items-center gap-2">
                                <span class="relative flex h-3 w-3"><span
                                        class="relative inline-flex h-3 w-3 bg-red-500 rounded-full"></span></span>
                                <span class="text-red-600 font-semibold text-sm">Offline</span>
                            </div>
                            <div
                                class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="online-toggle"
                                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out" />
                                <label for="online-toggle"
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="relative">
                            <i data-lucide="bell" class="text-gray-500 cursor-pointer"></i>
                            <span id="notification-badge"
                                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs h-4 w-4 rounded-full flex items-center justify-center hidden">0</span>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-6">

                    <div id="dashboard-page">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                            <div class="bg-white p-4 shadow rounded-lg">
                                <h3 class="text-sm text-gray-500">Today's Contribution</h3>
                                <p id="todays-points-card" class="text-2xl font-bold mt-1">0 pts</p>
                                <p class="text-sm text-green-600 flex items-center mt-1">Keep up the great work!</p>
                            </div>
                            <div class="bg-white p-4 shadow rounded-lg">
                                <h3 class="text-sm text-gray-500">Today's Collections</h3>
                                <p id="todays-collections-card" class="text-2xl font-bold mt-1">0</p>
                                <p class="text-sm text-gray-500 flex items-center mt-1">&nbsp;</p>
                            </div>
                            <div class="bg-white p-4 shadow rounded-lg">
                                <h3 class="text-sm text-gray-500">Avg. Pickup Time</h3>
                                <p class="text-2xl font-bold mt-1">12m</p>
                                <p class="text-sm text-gray-500 flex items-center mt-1">Last 7 days</p>
                            </div>
                            <div class="bg-white p-4 shadow rounded-lg">
                                <h3 class="text-sm text-gray-500">Donor Rating</h3>
                                <p class="text-2xl font-bold mt-1">4.9 â˜…</p>
                                <p class="text-sm text-gray-500 flex items-center mt-1">Excellent service</p>
                            </div>
                            <div class="bg-white p-4 shadow rounded-lg flex flex-col justify-center">
                                <p class="text-sm text-gray-500">Total Contribution</p>
                                <p id="total-points-card" class="text-2xl font-bold text-blue-600">0 pts</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 shadow rounded-lg">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h3 class="font-semibold">Current Location & Route</h3>
                                        <p id="current-location-text" class="text-sm text-gray-500">Fetching location...
                                        </p>
                                    </div>
                                    <button id="recenter-map"
                                        class="text-sm text-blue-600 font-semibold hover:underline">Recenter</button>
                                </div>
                                <div id="map-container" class="w-full h-[400px] bg-gray-200 rounded-lg overflow-hidden">
                                </div>
                            </div>
                            <div id="active-delivery-container" class="bg-white p-6 shadow rounded-lg flex flex-col">
                                <div class="flex flex-col items-center justify-center h-full text-center">
                                    <i data-lucide="truck" class="w-16 h-16 text-gray-300 mb-4"></i>
                                    <h3 class="font-semibold text-gray-700">No Active Delivery</h3>
                                    <p class="text-sm text-gray-500 mt-1">Accept a pickup to see details here.</p>
                                </div>
                            </div>
                        </div>

                        <div id="pending-orders-section" class="mt-6 bg-white p-6 shadow rounded-lg relative">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">Available Pickups</h3>
                                <span id="db-status" class="text-sm text-gray-500">Connecting to database...</span>
                            </div>
                            <div id="pending-orders-container" class="space-y-4 max-h-64 overflow-y-auto pr-2">
                            </div>
                            <div id="offline-overlay"
                                class="absolute inset-0 bg-gray-50 bg-opacity-80 flex items-center justify-center rounded-lg">
                                <p class="text-lg font-semibold text-gray-700">You are offline. Go online to see new
                                    pickups.</p>
                            </div>
                            <div id="active-delivery-overlay"
                                class="absolute inset-0 bg-gray-50 bg-opacity-80 flex flex-col items-center justify-center hidden text-center p-4 rounded-lg">
                                <i data-lucide="truck" class="w-12 h-12 text-blue-600 mb-2"></i>
                                <p class="text-lg font-semibold text-gray-700">Delivery in Progress</p>
                                <p class="text-sm text-gray-500">Please complete your active delivery to accept new
                                    pickups.</p>
                            </div>
                        </div>

                        <div class="mt-6 bg-white p-6 shadow rounded-lg">
                            <h3 class="font-semibold mb-4">Today's Completed Collections</h3>
                            <div id="completed-orders-container" class="space-y-4 max-h-64 overflow-y-auto pr-2">
                                <p class="text-sm text-gray-500">No collections completed yet today.</p>
                            </div>
                        </div>
                    </div>

                    <div id="profile-page" class="hidden"></div>
                </div>
            </main>
        </div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {

                // --- YOUR FIREBASE CONFIGURATION ---
                const firebaseConfig = {
                    apiKey: "AIzaSyBDmqExQUrb5biHxu9ZZxZBaTZq6cK2mH4",
                    authDomain: "foodlink-be309.firebaseapp.com",
                    projectId: "foodlink-be309",
                    storageBucket: "foodlink-be309.appspot.com",
                    messagingSenderId: "362981391704",
                    appId: "1:362981391704:web:86434e32f4a77c8234f92d",
                    measurementId: "G-ZBPP67701F"
                };

                // --- INITIALIZE FIREBASE AND FIRESTORE ---
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const db = firebase.firestore();
                const CURRENT_RIDER_ID = 1; // Hardcoded for this demo rider

                // --- DOM ELEMENTS ---
                const onlineToggle = document.getElementById('online-toggle');
                const statusIndicator = document.getElementById('status-indicator');
                const dbStatus = document.getElementById('db-status');
                const offlineOverlay = document.getElementById('offline-overlay');
                const activeDeliveryOverlay = document.getElementById('active-delivery-overlay');
                const pendingOrdersContainer = document.getElementById('pending-orders-container');
                const activeDeliveryContainer = document.getElementById('active-delivery-container');
                const completedOrdersContainer = document.getElementById('completed-orders-container');
                const todaysPointsCard = document.getElementById('todays-points-card');
                const todaysCollectionsCard = document.getElementById('todays-collections-card');
                const totalPointsCard = document.getElementById('total-points-card');
                const notificationPopup = document.getElementById('donation-notification');
                const notificationText = document.getElementById('notification-text');
                const recenterMapBtn = document.getElementById('recenter-map');

                // --- STATE MANAGEMENT ---
                let state = {
                    isOnline: false,
                    activeDelivery: null,
                    pendingOrders: [],
                    completedOrders: [],
                    riderLocation: { lat: 22.3072, lng: 73.1812 }, // Default: Vadodara
                    stats: { todaysPoints: 0, todaysCollections: 0, totalPoints: 12500 }
                };

                // --- MAP INITIALIZATION ---
                const mapContainer = document.getElementById('map-container');
                mapContainer.innerHTML = '<div id="map" class="w-full h-full"></div>';
                const map = L.map('map').setView([state.riderLocation.lat, state.riderLocation.lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                const riderIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                });
                const riderMarker = L.marker([state.riderLocation.lat, state.riderLocation.lng], { icon: riderIcon, draggable: true }).addTo(map)
                    .bindPopup("<b>Your Location</b>").openPopup();

                riderMarker.on('dragend', function (e) {
                    const newPos = e.target.getLatLng();
                    state.riderLocation.lat = newPos.lat;
                    state.riderLocation.lng = newPos.lng;
                    renderPendingOrders();
                    lucide.createIcons();
                });

                let routingControl = null;

                // --- CONSTANTS ---
                const mockShelter = { name: "City Shelter Home", lat: 22.3021, lng: 73.2057 };

                // --- REAL-TIME FIRESTORE LISTENER ---
                function listenForDonations() {
                    let allAvailableDonations = {};

                    const processChanges = (querySnapshot) => {
                        dbStatus.textContent = "Listening for pickups...";
                        let changesMade = false;
                        querySnapshot.docChanges().forEach((change) => {
                            const docId = change.doc.id;
                            const donationData = change.doc.data();

                            const isRelevant =
                                (donationData.status === 'pending' && donationData.isNgoManaged === false) ||
                                (donationData.status === 'assigned' && donationData.assignedRider?.id === CURRENT_RIDER_ID);

                            if (change.type === "removed" || !isRelevant) {
                                if (allAvailableDonations[docId]) {
                                    delete allAvailableDonations[docId];
                                    changesMade = true;
                                }
                            } else { 
                                if (!donationData.location?.latitude || !donationData.location?.longitude) {
                                    console.warn("Skipping donation with invalid location data:", docId);
                                    return;
                                }
                                const newOrder = {
                                    id: docId,
                                    donor: donationData.donorName,
                                    foodType: donationData.foodItems,
                                    pickupLocation: {
                                        lat: donationData.location.latitude,
                                        lng: donationData.location.longitude
                                    },
                                    dropoffLocation: { lat: mockShelter.lat, lng: mockShelter.lng },
                                    points: Math.floor(Math.random() * 20) + 15,
                                    status: donationData.status
                                };

                                if (!allAvailableDonations[docId] && state.isOnline) {
                                    showNotification(newOrder);
                                }

                                allAvailableDonations[docId] = newOrder;
                                changesMade = true;
                            }
                        });

                        if (changesMade) {
                            state.pendingOrders = Object.values(allAvailableDonations);
                            renderPendingOrders();
                        }
                    };

                    const handleError = (error) => {
                        dbStatus.textContent = "Database connection error.";
                        console.error("Firestore listener error:", error);
                    };

                    db.collection("donations").where("status", "==", "pending").where("isNgoManaged", "==", false).onSnapshot(processChanges, handleError);
                    db.collection("donations").where("status", "==", "assigned").where("assignedRider.id", "==", CURRENT_RIDER_ID).onSnapshot(processChanges, handleError);
                }

                // --- RENDER FUNCTIONS (FIXED) ---
                const renderUI = () => {
                    renderOnlineStatus();
                    renderOverlays();
                    renderPendingOrders();
                    renderActiveDelivery();
                    renderCompletedOrders();
                    updateStats();
                    lucide.createIcons();
                };
                
                const renderOnlineStatus = () => {
                    if (state.isOnline) {
                        statusIndicator.innerHTML = `
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        <span class="text-green-600 font-semibold text-sm">Online</span>`;
                    } else {
                        statusIndicator.innerHTML = `
                        <span class="relative flex h-3 w-3"><span class="relative inline-flex h-3 w-3 bg-red-500 rounded-full"></span></span>
                        <span class="text-red-600 font-semibold text-sm">Offline</span>`;
                    }
                    onlineToggle.checked = state.isOnline;
                };

                const renderOverlays = () => {
                    offlineOverlay.style.display = state.isOnline ? 'none' : 'flex';
                    activeDeliveryOverlay.style.display = state.activeDelivery ? 'flex' : 'none';
                };

                const renderPendingOrders = () => {
                    if (!state.isOnline) {
                        pendingOrdersContainer.innerHTML = ''; return;
                    }
                    if (state.pendingOrders.length === 0) {
                        pendingOrdersContainer.innerHTML = `<p class="text-sm text-gray-500">No available pickups.</p>`; return;
                    }
                    pendingOrdersContainer.innerHTML = state.pendingOrders.map(order => {
                        const pickupLatLng = L.latLng(order.pickupLocation.lat, order.pickupLocation.lng);
                        const distance = (L.latLng(state.riderLocation).distanceTo(pickupLatLng) / 1000).toFixed(1);

                        return `<div class="border rounded-lg p-4 flex justify-between items-center transition hover:shadow-md"><div><p class="font-semibold">${order.donor}</p><p class="text-sm text-gray-600">${order.foodType}</p><p class="text-xs text-gray-400 mt-1 flex items-center gap-2"><span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i>${distance} km away</span><span class="flex items-center gap-1"><i data-lucide="award" class="w-3 h-3"></i>${order.points} pts</span></p></div><button data-order-id="${order.id}" class="accept-btn bg-blue-600 text-white px-4 py-2 text-sm font-semibold rounded-lg hover:bg-blue-700">Accept</button></div>`;
                    }).join('');
                    lucide.createIcons();
                };

                const renderActiveDelivery = () => {
                    if (!state.activeDelivery) {
                        activeDeliveryContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><i data-lucide="truck" class="w-16 h-16 text-gray-300 mb-4"></i><h3 class="font-semibold text-gray-700">No Active Delivery</h3><p class="text-sm text-gray-500 mt-1">Accept a pickup to see details here.</p></div>`;
                        updateMapRoute();
                        lucide.createIcons();
                        return;
                    }
                    const { donor, foodType, points, status } = state.activeDelivery;
                    let actionButton, title, locationText;
                    if (status === 'accepted') {
                        title = `Pickup from: <span class="font-bold">${donor}</span>`;
                        locationText = `Food: ${foodType}`;
                        actionButton = `<button data-order-id="${state.activeDelivery.id}" class="pickup-btn w-full bg-green-600 text-white py-2.5 font-semibold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"><i data-lucide="package-check" class="w-4 h-4"></i>Mark as Picked Up</button>`;
                    } else { // 'picked_up' status
                        title = `Deliver to: <span class="font-bold">${mockShelter.name}</span>`;
                        locationText = `Delivering: ${foodType} from ${donor}`;
                        actionButton = `<button data-order-id="${state.activeDelivery.id}" class="deliver-btn w-full bg-purple-600 text-white py-2.5 font-semibold rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2"><i data-lucide="home" class="w-4 h-4"></i>Mark as Delivered</button>`;
                    }
                    activeDeliveryContainer.innerHTML = `<h3 class="font-semibold mb-1">Active Delivery</h3><div class="border-t pt-3 flex-grow flex flex-col"><p class="text-gray-700">${title}</p><p class="text-sm text-gray-500">${locationText}</p><div class="my-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center"><p class="text-sm text-blue-800">Contribution</p><p class="text-2xl font-bold text-blue-600">${points} pts</p></div><div class="mt-auto">${actionButton}</div></div>`;
                    updateMapRoute();
                    lucide.createIcons();
                };

                const renderCompletedOrders = () => {
                    if (state.completedOrders.length === 0) {
                        completedOrdersContainer.innerHTML = `<p class="text-sm text-gray-500">No collections completed yet today.</p>`;
                        return;
                    }
                    completedOrdersContainer.innerHTML = state.completedOrders.map(order => `
                        <div class="border-b pb-2 flex justify-between items-center text-sm">
                            <div>
                                <p class="font-medium text-gray-800">From: ${order.donor}</p>
                                <p class="text-xs text-gray-500">To: ${mockShelter.name}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-green-600">+${order.points} pts</p>
                                <p class="text-xs text-gray-500">${new Date(order.completedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                        </div>`).join('');
                };

                const updateStats = () => {
                    todaysPointsCard.textContent = `${state.stats.todaysPoints} pts`;
                    todaysCollectionsCard.textContent = state.stats.todaysCollections;
                    totalPointsCard.textContent = `${state.stats.totalPoints.toLocaleString()} pts`;
                };

                const updateMapRoute = () => {
                    if (routingControl) {
                        map.removeControl(routingControl);
                        routingControl = null;
                    }
                    if (!state.activeDelivery) return;
                    const riderLatLng = L.latLng(state.riderLocation);
                    const pickupLatLng = L.latLng(state.activeDelivery.pickupLocation.lat, state.activeDelivery.pickupLocation.lng);
                    const dropoffLatLng = L.latLng(state.activeDelivery.dropoffLocation.lat, state.activeDelivery.dropoffLocation.lng);
                    let waypoints = (state.activeDelivery.status === 'accepted') ? [riderLatLng, pickupLatLng] : [riderLatLng, dropoffLatLng];
                    routingControl = L.Routing.control({ waypoints, createMarker: () => null, routeWhileDragging: false, lineOptions: { styles: [{ color: '#2563eb', opacity: 0.8, weight: 6 }] } }).addTo(map);
                    map.fitBounds(L.latLngBounds(waypoints).pad(0.2));
                };

                const showNotification = (order) => {
                    notificationText.textContent = `${order.foodType} from ${order.donor}`;
                    notificationPopup.classList.add('show', 'notification-pulse');
                    setTimeout(() => {
                        notificationPopup.classList.remove('show', 'notification-pulse');
                    }, 5000);
                };


                // --- EVENT HANDLERS ---
                onlineToggle.addEventListener('change', () => {
                    state.isOnline = onlineToggle.checked;
                    renderUI();
                });


                recenterMapBtn.addEventListener('click', () => {
                    map.setView(state.riderLocation, 13);
                });

                document.body.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-order-id]');
                    if (!button) return;
                    const orderId = button.dataset.orderId;

                    if (button.matches('.accept-btn')) {
                        const orderToAccept = state.pendingOrders.find(o => o.id === orderId);
                        if (orderToAccept) {
                            const riderDetails = { id: CURRENT_RIDER_ID, name: 'Rajesh Kumar' };
                            db.collection("donations").doc(orderId).update({
                                status: "accepted",
                                assignedRider: riderDetails,
                                assignedAt: firebase.firestore.FieldValue.serverTimestamp()
                            })
                                .then(() => {
                                    state.activeDelivery = { ...orderToAccept, status: 'accepted' };
                                    renderUI();
                                })
                                .catch(error => console.error("Error accepting order: ", error));
                        }
                    } else if (button.matches('.pickup-btn')) {
                        if (state.activeDelivery && state.activeDelivery.id === orderId) {
                            db.collection("donations").doc(orderId).update({ status: "picked_up" });
                            state.activeDelivery.status = 'picked_up';
                            renderUI();
                        }
                    } else if (button.matches('.deliver-btn')) {
                        if (state.activeDelivery && state.activeDelivery.id === orderId) {
                            db.collection("donations").doc(orderId).update({ status: "delivered" })
                                .then(() => {
                                    const completed = { ...state.activeDelivery, status: 'delivered', completedAt: Date.now() };
                                    state.completedOrders.unshift(completed);
                                    state.stats.todaysPoints += completed.points;
                                    state.stats.totalPoints += completed.points;
                                    state.stats.todaysCollections += 1;
                                    state.activeDelivery = null;
                                    renderUI();
                                });
                        }
                    }
                });

                // --- INITIALIZATION ---
                listenForDonations();
                renderUI();
            });
        </script>
    </body>

</html>